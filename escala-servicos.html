<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPP - Escala de Serviços</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }

        html {
            height: 100%;
            background: linear-gradient(135deg, #1c052e, #2a0845, #1d0638);
            background-size: 300% 300%;
            background-attachment: fixed;
            animation: purpleGradient 12s ease-in-out infinite;
        }

        @keyframes purpleGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        body {
            background: transparent;
            color: #f3e5f5;
            min-height: 100vh;
        }

        /* Glassmorphism Card Style */
        .glass-card {
            background: rgba(20, 2, 40, 0.45);
            backdrop-filter: blur(12px) saturate(150%);
            -webkit-backdrop-filter: blur(12px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1rem; /* 16px */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* Highlight for Perito and searched user rows */
        .perito-row {
            background-color: rgba(45, 11, 66, 0.8) !important;
            color: #e9d5ff;
            font-weight: 600;
        }
        
        .highlight-row {
             background-color: rgba(134, 44, 204, 0.7) !important;
             box-shadow: 0 0 15px rgba(192, 132, 252, 0.5);
             font-weight: 700;
        }
        tr.highlight-row td {
            color: #fff !important;
        }

        /* Status classes */
        .status-cell {
            transition: background-color 0.3s ease;
            border-radius: 4px;
        }
        .status-feito { background-color: rgba(34, 197, 94, 0.5); } /* green-500/50 */
        .status-hoje { background-color: rgba(250, 204, 21, 0.5); } /* yellow-400/50 */
        .status-justificado { background-color: rgba(59, 130, 246, 0.5); } /* blue-500/50 */
        .status-pendente { background-color: rgba(239, 68, 68, 0.5); } /* red-500/50 */

        /* Styles for new controls */
        .control-btn {
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .control-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .control-btn.active {
            background-color: #a855f7; /* purple-500 */
            color: white;
            font-weight: 600;
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.7);
        }
        
        /* Performance Status Styles */
        .status-regular { background-color: rgba(34, 197, 94, 0.8); color: white; }
        .status-irregular { background-color: rgba(239, 68, 68, 0.8); color: white; }
        .status-especial { background-color: rgba(107, 114, 128, 0.8); color: white; }
        .status-verificar { background-color: rgba(168, 85, 247, 0.7); color: white; }


    </style>
</head>
<body class="text-white">

    <!-- Header -->
    <header class="glass-card sticky top-0 z-50 m-4">
        <div class="container mx-auto px-6 py-4">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center">
                    <i class="fas fa-shield-halved text-3xl text-purple-400 mr-3"></i>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Serviço de Proteção dos Professores</h1>
                </div>
                <nav>
                    <a class='text-gray-200 hover:text-white font-semibold px-3 py-2' href='/'>Voltar à Página Inicial</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 py-12">
        <h2 class="text-4xl font-bold text-white mb-8 text-center drop-shadow-lg">Escala de Serviços</h2>

        <!-- Today's Responsibilities -->
        <div id="today-responsibilities" class="glass-card p-6 mb-8 max-w-3xl mx-auto hidden">
            <h3 class="text-2xl font-bold text-center text-white mb-4 drop-shadow-md">
                <i class="fas fa-calendar-day mr-2 text-purple-300"></i>Postagens de Hoje
            </h3>
            <ul id="today-responsibilities-list" class="space-y-2 sm:columns-2 sm:gap-x-8 text-center sm:text-left">
                <!-- JS will populate this list -->
            </ul>
        </div>
        
        <!-- Controls: Filters and Search -->
        <div id="controls-container" class="glass-card p-4 mb-8 max-w-5xl mx-auto">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Team Filter Buttons -->
                <div class="flex-grow">
                    <label class="block text-sm font-semibold mb-2 text-purple-300">Filtrar por equipe:</label>
                    <div id="team-buttons" class="flex flex-wrap gap-2">
                        <!-- Buttons will be injected by JS -->
                    </div>
                </div>
                <!-- Search -->
                <div class="lg:border-l lg:border-white/20 lg:pl-6">
                     <label for="search-input" class="block text-sm font-semibold mb-2 text-purple-300">Pesquise seu nick:</label>
                     <div class="flex gap-2">
                         <input type="text" id="search-input" placeholder="Digite o nick ou perito..." class="w-full bg-black/20 rounded-md py-2 px-3 border border-white/20 focus:outline-none focus:ring-2 focus:ring-purple-500 transition">
                         <button id="search-btn" class="control-btn font-semibold py-2 px-4 rounded-md">
                             <i class="fas fa-search"></i>
                         </button>
                     </div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div id="legend" class="glass-card p-4 mb-8 max-w-2xl mx-auto hidden">
            <h3 class="text-lg font-semibold text-center mb-3">Legenda de Cores</h3>
            <ul class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-2 text-sm text-center">
                <li class="flex items-center justify-center gap-2"><span class="h-4 w-4 rounded-full status-feito"></span> Feito</li>
                <li class="flex items-center justify-center gap-2"><span class="h-4 w-4 rounded-full status-hoje"></span> Hoje</li>
                <li class="flex items-center justify-center gap-2"><span class="h-4 w-4 rounded-full status-pendente"></span> Pendente</li>
                <li class="flex items-center justify-center gap-2"><span class="h-4 w-4 rounded-full status-justificado"></span> Justificado</li>
            </ul>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center py-10">
            <i class="fas fa-spinner fa-spin text-4xl text-white"></i>
            <p class="mt-2 text-white/80">Carregando e verificando escalas...</p>
        </div>
        
        <!-- Messages Container -->
        <div id="message-container" class="text-center py-10"></div>

        <!-- Schedule Container -->
        <div id="schedule-container" class="space-y-12">
            <!-- As escalas das equipes serão inseridas aqui -->
        </div>

    </main>

    <!-- Footer -->
    <footer class="glass-card mt-12 mx-4 mb-4">
        <div class="container mx-auto px-6 py-4 text-center text-white/70 text-sm">
            <p class="mb-1">&copy; 2024 Serviço de Proteção dos Professores. Todos os direitos reservados.</p>
            <p>Desenvolvido por <strong class="text-white/90">Pegas</strong> e idealizado por <strong class="text-white/90">Sr.Gabriel</strong>.</p>
        </div>
    </footer>

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-6 right-6 z-40 flex flex-col gap-4">
        <button id="performance-btn" class="h-14 w-14 bg-blue-500 hover:bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg transition-transform hover:scale-110" title="Consulta de Desempenho">
            <i class="fas fa-chart-line text-2xl"></i>
        </button>
        <button id="warnings-btn" class="h-14 w-14 bg-yellow-500 hover:bg-yellow-600 text-white rounded-full flex items-center justify-center shadow-lg transition-transform hover:scale-110" title="Painel de Advertências">
            <i class="fas fa-triangle-exclamation text-2xl"></i>
        </button>
        <button id="help-btn" class="h-14 w-14 bg-purple-600 hover:bg-purple-700 text-white rounded-full flex items-center justify-center shadow-lg transition-transform hover:scale-110" title="Ajuda">
            <i class="fas fa-question text-2xl"></i>
        </button>
    </div>
    
    <!-- Performance Modal -->
    <div id="performance-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="glass-card max-w-4xl w-full m-4 p-6 rounded-2xl">
             <div class="flex justify-between items-center mb-4">
                 <h3 class="text-2xl font-bold text-white"><i class="fas fa-chart-line mr-2 text-blue-300"></i>Consulta de Desempenho</h3>
                 <button id="close-performance-btn" class="text-gray-300 hover:text-white text-2xl">&times;</button>
             </div>
             <div id="performance-period" class="text-center text-purple-300 mb-4"></div>
             <div id="performance-list-container" class="max-h-[60vh] overflow-y-auto pr-2">
                 <!-- JS will populate this list -->
             </div>
        </div>
    </div>


    <!-- Warnings Modal -->
    <div id="warnings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="glass-card max-w-2xl w-full m-4 p-6 rounded-2xl">
             <div class="flex justify-between items-center mb-4">
                 <h3 class="text-2xl font-bold text-white"><i class="fas fa-triangle-exclamation mr-2 text-yellow-300"></i>Painel de Advertências</h3>
                 <button id="close-warnings-btn" class="text-gray-300 hover:text-white text-2xl">&times;</button>
             </div>
             <div id="warnings-list-container" class="max-h-[60vh] overflow-y-auto pr-2">
                 <ul id="warnings-list" class="space-y-3">
                     <!-- JS will populate this list -->
                 </ul>
             </div>
        </div>
    </div>


    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="glass-card max-w-lg w-full m-4 p-6 rounded-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-white"><i class="fas fa-question-circle mr-2 text-purple-300"></i>Como Entender a Escala</h3>
                <button id="close-help-btn" class="text-gray-300 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="space-y-4 text-gray-200">
                <p>A escala mostra as datas das suas tarefas de <strong>Fiscalização</strong> e os prazos para a <strong>Postagem</strong> dos relatórios.</p>
                <div>
                    <h4 class="font-semibold text-purple-300">Passo a Passo:</h4>
                    <ol class="list-decimal list-inside mt-2 space-y-2">
                        <li><strong>Encontre seu nome:</strong> Localize sua linha na tabela da sua equipe.</li>
                        <li><strong>Verifique as datas:</strong> Cada linha tem tarefas de Fiscalização (Fisc.) e de Postagem (Post.).</li>
                        <li><strong>Entenda o prazo:</strong> A data na coluna "Postagem" é o <strong>prazo final</strong> para você realizar a "Fiscalização" correspondente.</li>
                    </ol>
                </div>
                <div class="bg-black/20 p-3 rounded-lg">
                    <p><strong>Exemplo Prático:</strong></p>
                    <p class="mt-1">Se sua <strong>Fisc. 1</strong> está agendada para o dia <strong>18/06</strong> e a <strong>Post. 1</strong> para <strong>19/06</strong>, isso significa que:</p>
                    <ul class="list-disc list-inside ml-4 mt-2">
                        <li>Você deve fiscalizar as atividades do dia <strong>18/06</strong>.</li>
                        <li>Seu prazo para fazer isso e postar o relatório termina no final do dia <strong>19/06</strong>.</li>
                    </ul>
                </div>
                <p>As cores nas células te ajudam a ver rapidamente o que está pendente (<span class="status-pendente px-1 rounded">vermelho</span>), o que vence hoje (<span class="status-hoje px-1 rounded">amarelo</span>) ou o que já foi feito (<span class="status-feito px-1 rounded">verde</span>).</p>
            </div>
        </div>
    </div>


    <script>
        // --- Configuration ---
        const API_KEY = 'AIzaSyBQhWdy4iyFCk9Lh89x8weSIyl0knXgA34';
        const SCHEDULE_SPREADSHEET_ID = '19u9h0OnF_BlD5w8rTE9zaksh3ImMemXFQm1oob_A1Eo';
        const REPORTS_SPREADSHEET_ID = '18iZ8Dm4rCQL2y5Rurqpb61zh3RZpUApBArjNrrHufOY';
        const MEMBERS_SPREADSHEET_ID = '1kFnRqlQ-8Bzlv578t9uC_T0C74jjsK3nbzBgRFTlAJM';

        const TEAMS = [
            { name: '[SPP] Equipe Alpha', reportTab: 'Equipe Alpha', range: 'C13:J17' },
            { name: '[SPP] Equipe Beta', reportTab: 'Equipe Beta', range: 'C13:J17' },
            { name: '[SPP] Equipe Delta', reportTab: 'Equipe Delta', range: 'C13:J17' },
            { name: '[SPP] Equipe Ômega', reportTab: null, range: 'C14:C16' }
        ];
        
        // --- Global State ---
        let processedSchedule = [];
        let activityMaps = {};
        let memberInfoMap = new Map();

        // --- DOM Elements ---
        const loadingEl = document.getElementById('loading');
        const legendEl = document.getElementById('legend');
        const scheduleContainer = document.getElementById('schedule-container');
        const messageContainer = document.getElementById('message-container');
        const teamButtonsContainer = document.getElementById('team-buttons');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');

        // --- Date Helper ---
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        function parseDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            
            // Try "DD/MM/YYYY" format
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                const [day, month, year] = dateStr.split('/');
                const date = new Date(year, month - 1, day);
                date.setHours(0,0,0,0);
                return date;
            }
            
            // Try "DD mon.YYYY" format
            const monthMap = { 'jan': 0, 'fev': 1, 'mar': 2, 'abr': 3, 'mai': 4, 'jun': 5, 'jul': 6, 'ago': 7, 'set': 8, 'out': 9, 'nov': 10, 'dez': 11 };
            const cleanedStr = dateStr.replace('.', '').toLowerCase();
            const parts = cleanedStr.split(' ');
            if (parts.length !== 3) return null;
            const [day, monthStr, year] = parts;
            if (isNaN(day) || isNaN(year) || !monthMap.hasOwnProperty(monthStr)) return null;
            const date = new Date(year, monthMap[monthStr], day);
            date.setHours(0,0,0,0);
            return date;
        }

        // --- Data Fetching and Processing ---
        async function fetchAllData() {
            try {
                const [scheduleData, reportData, memberData] = await Promise.all([ 
                    fetchScheduleData(), 
                    fetchReportData(),
                    fetchMemberData()
                ]);
                
                activityMaps = processReportData(reportData);
                memberInfoMap = processMemberData(memberData.values || []);
                processedSchedule = processScheduleData(scheduleData);
                
                renderControls();
                renderTodaysResponsibilities(processedSchedule);
                renderWarnings(processedSchedule);
                calculateAndRenderPerformance(processedSchedule, memberInfoMap);
                displaySchedules('all');
                
                legendEl.classList.remove('hidden');

            } catch (error) {
                console.error('Erro ao buscar ou processar dados:', error);
                messageContainer.innerHTML = `<div class="glass-card text-red-300 text-center p-4"><p>Não foi possível carregar as escalas. Tente recarregar a página.</p><p class="text-xs mt-2">${error.message}</p></div>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }
        
        async function fetchScheduleData() {
            const ranges = TEAMS.flatMap(t => [`'${t.name}'!C9`,`'${t.name}'!F11`,`'${t.name}'!I11`,`'${t.name}'!F20:G20`,`'${t.name}'!${t.range}`]);
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SCHEDULE_SPREADSHEET_ID}/values:batchGet?ranges=${ranges.join('&ranges=')}&key=${API_KEY}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Falha ao buscar dados da escala.');
            return response.json();
        }

        async function fetchReportData() {
            const reportTeams = TEAMS.filter(t => t.reportTab);
            const ranges = reportTeams.flatMap(t => [`'${t.reportTab}'!C14:F400`, `'${t.reportTab}'!N14:P400`]);
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${REPORTS_SPREADSHEET_ID}/values:batchGet?ranges=${ranges.join('&ranges=')}&key=${API_KEY}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Falha ao buscar dados dos relatórios.');
            return response.json();
        }
        
        async function fetchMemberData() {
            const range = 'Gerador!B16:I37';
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${MEMBERS_SPREADSHEET_ID}/values/${range}?key=${API_KEY}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Falha ao buscar dados dos membros.');
            return response.json();
        }

        function processScheduleData(data) {
            return TEAMS.map((team, index) => {
                const peritoRaw = data.valueRanges[index * 5]?.values?.[0]?.[0] || 'N/A';
                return {
                    id: team.name,
                    name: team.name.replace('[SPP] ', ''),
                    isOmega: team.name.includes('Ômega'),
                    peritoResponsavel: peritoRaw.replace(/Perito Responsável:\s*/i, '').trim(),
                    tituloFiscalizacao: data.valueRanges[index * 5 + 1]?.values?.[0]?.[0] || 'Fiscalização',
                    tituloPostagem: data.valueRanges[index * 5 + 2]?.values?.[0]?.[0] || 'Postagem',
                    periodoReferencia: data.valueRanges[index * 5 + 3]?.values?.[0] || [],
                    tableData: data.valueRanges[index * 5 + 4]?.values || [],
                };
            });
        }

        function processReportData(data) {
            const fiscalizacoes = new Map(); 
            const postagens = new Map(); 
            const justificativas = new Map();

            if (!data.valueRanges) return { fiscalizacoes, postagens, justificativas };
            
            data.valueRanges.forEach(rangeData => {
                const rows = rangeData.values || [];
                if (rangeData.range.includes('!C')) {
                    rows.forEach(([timestamp, nick, , fiscDate]) => {
                        const trimmedNick = nick ? nick.trim() : '';
                        const trimmedFiscDate = fiscDate ? fiscDate.trim() : '';

                        if (trimmedNick && trimmedFiscDate) {
                            const nickLower = trimmedNick.toLowerCase();
                            if (!fiscalizacoes.has(trimmedFiscDate)) fiscalizacoes.set(trimmedFiscDate, []);
                            fiscalizacoes.get(trimmedFiscDate).push(nickLower);
                        }
                        if (trimmedNick && timestamp) {
                            const postDate = timestamp.split(' ')[0];
                            if (!postagens.has(postDate)) postagens.set(postDate, []);
                            postagens.get(postDate).push(trimmedNick.toLowerCase());
                        }
                    });
                } else if (rangeData.range.includes('!N')) {
                     rows.forEach(([nick, , justifDate]) => {
                         const trimmedNick = nick ? nick.trim() : '';
                         const trimmedJustifDate = justifDate ? justifDate.trim() : '';

                         if (trimmedNick && trimmedJustifDate) {
                             const key = `${trimmedJustifDate}-${trimmedNick.toLowerCase()}`;
                             if(!justificativas.has(key)) justificativas.set(key, true);
                         }
                     });
                }
            });
            return { fiscalizacoes, postagens, justificativas };
        }
        
        function processMemberData(memberRows) {
            const map = new Map();
            memberRows.forEach(row => {
                const nick = row[1];
                if (nick) {
                    map.set(nick.trim().toLowerCase(), {
                        cargo: row[0] || null,
                        nick: nick.trim(),
                        entrada: parseDate(row[2]),
                        inicioLicenca: parseDate(row[4]),
                        terminoLicenca: parseDate(row[6]),
                        retornoLicenca: row[7] === 'TRUE',
                    });
                }
            });
            return map;
        }
        
        function getStatus(assignedNick, dateStr, type, deadlineOverrideDateStr = null) {
            if (type === 'fiscalizacao' && assignedNick.toLowerCase() === 'perito') {
                return { class: '', tooltip: 'Atividade do Perito' };
            }
            if (!dateStr || dateStr === '-') return { class: '', tooltip: '' };

            const scheduleDate = parseDate(dateStr);
            if (!scheduleDate) return { class: '', tooltip: '' };

            const deadlineDate = deadlineOverrideDateStr ? parseDate(deadlineOverrideDateStr) : scheduleDate;
            if(!deadlineDate) return { class: '', tooltip: '' };
            
            const nickLower = assignedNick.toLowerCase();
            const completedMap = type === 'fiscalizacao' ? activityMaps.fiscalizacoes : activityMaps.postagens;

            const completedKey = type === 'fiscalizacao' ? dateStr : scheduleDate.toLocaleDateString('pt-BR');
            if (completedMap.has(completedKey) && completedMap.get(completedKey).includes(nickLower)) {
                return { class: 'status-feito', tooltip: `Concluído por ${assignedNick} em ${completedKey}` };
            }
            
            const justificationKey = `${dateStr}-${nickLower}`;
            if (activityMaps.justificativas.has(justificationKey)) {
                return { class: 'status-justificado', tooltip: `Justificado por ${assignedNick} para ${dateStr}` };
            }

            if (deadlineDate.getTime() === today.getTime()) {
                return { class: 'status-hoje', tooltip: `Prazo final hoje (${dateStr})` };
            }
            
            if (deadlineDate < today) {
                return { class: 'status-pendente', tooltip: `Pendente desde ${dateStr}` };
            }

            return { class: '', tooltip: `Prazo: ${dateStr}` };
        }
        
        // --- Rendering ---
        function renderTodaysResponsibilities(schedule) {
            const todayStr = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const container = document.getElementById('today-responsibilities');
            const list = document.getElementById('today-responsibilities-list');
            list.innerHTML = ''; 
        
            let hasAnyResponsibility = false;
        
            schedule.forEach(teamData => {
                if (teamData.isOmega) return;
        
                const todaysPosters = [];
                const tableRowsData = teamData.tableData.slice(1);
        
                tableRowsData.forEach(row => {
                    const nick = row[0] || '';
                    if (!nick) return;
        
                    const isPeritoRow = nick.toLowerCase() === 'perito';
                    const memberName = isPeritoRow ? teamData.peritoResponsavel : nick;
        
                    const postDates = [row[6], row[7]];
                    
                    postDates.forEach((date, index) => {
                        if (date === todayStr) {
                             hasAnyResponsibility = true;
                             const fiscDate = row[index === 0 ? 3 : 4]; 
                             const isCompleted = activityMaps.fiscalizacoes.has(fiscDate) && activityMaps.fiscalizacoes.get(fiscDate).includes(memberName.toLowerCase());
                             
                             if (!todaysPosters.some(p => p.name === memberName)) {
                                 todaysPosters.push({ name: memberName, completed: isCompleted });
                             }
                        }
                    });
                });
        
                if (todaysPosters.length > 0) {
                    const membersHTML = todaysPosters.map(poster => {
                        const icon = poster.completed 
                            ? `<i class="fas fa-check-circle text-green-400 ml-2" title="Concluído"></i>` 
                            : '';
                        return `${poster.name}${icon}`;
                    }).join(', ');
                    
                    const listItem = document.createElement('li');
                    listItem.className = 'text-white';
                    listItem.innerHTML = `<strong class="text-purple-300">${teamData.name}:</strong> ${membersHTML}`;
                    list.appendChild(listItem);
                }
            });
        
            if (!hasAnyResponsibility) {
                 const listItem = document.createElement('li');
                 listItem.className = 'text-gray-400 text-center';
                 listItem.textContent = 'Nenhuma postagem agendada para hoje.';
                 list.appendChild(listItem);
            }
            
            container.classList.remove('hidden');
        }

        function renderWarnings(schedule) {
            const list = document.getElementById('warnings-list');
            const warnings = [];

            schedule.forEach(teamData => {
                if (teamData.isOmega) return;
                const tableRowsData = teamData.tableData.slice(1);

                tableRowsData.forEach(row => {
                    const nick = row[0] || '';
                    if (!nick) return;

                    const isPeritoRow = nick.toLowerCase() === 'perito';
                    const memberName = isPeritoRow ? teamData.peritoResponsavel : nick;

                    const tasks = [
                        { fiscDate: row[3], postDate: row[6] },
                        { fiscDate: row[4], postDate: row[7] }
                    ];

                    tasks.forEach(task => {
                        const deadline = parseDate(task.postDate);
                        if (deadline && deadline < today) {
                            const isDoneBySelf = activityMaps.fiscalizacoes.has(task.fiscDate) && activityMaps.fiscalizacoes.get(task.fiscDate).includes(memberName.toLowerCase());
                            const justificationKey = `${task.fiscDate}-${memberName.toLowerCase()}`;
                            const isJustified = activityMaps.justificativas.has(justificationKey);
                            
                            if (!isDoneBySelf && !isJustified) {
                                warnings.push({
                                    nick: memberName,
                                    team: teamData.name,
                                    fiscDate: task.fiscDate,
                                    postDate: task.postDate
                                });
                            }
                        }
                    });
                });
            });

            if (warnings.length > 0) {
                list.innerHTML = warnings.map(w => `
                    <li class="bg-red-900/40 p-3 rounded-lg flex flex-col sm:flex-row justify-between items-center gap-2">
                        <div class="mb-2 sm:mb-0 text-center sm:text-left">
                            <strong class="text-yellow-300">${w.nick}</strong>
                            <span class="text-gray-300">(${w.team})</span>
                        </div>
                        <div class="text-sm text-gray-200 text-center sm:text-right">
                            Tarefa de <strong>${w.fiscDate}</strong> com prazo em <strong>${w.postDate}</strong> não cumprida.
                        </div>
                    </li>
                `).join('');
            } else {
                 list.innerHTML = `<li class="text-green-400 text-center p-4">Nenhuma advertência pendente. Todos em dia!</li>`;
            }
        }
        
        function calculateAndRenderPerformance(schedule, members) {
            const container = document.getElementById('performance-list-container');
            const periodEl = document.getElementById('performance-period');
            let performanceData = [];

            const firstTeam = schedule.find(t => !t.isOmega);
            const startDate = firstTeam ? parseDate(firstTeam.periodoReferencia[0]) : null;
            const endDate = firstTeam ? parseDate(firstTeam.periodoReferencia[1]) : null;
            
            const peritoNicks = new Set(schedule.map(t => t.peritoResponsavel.toLowerCase()));

            if (firstTeam && startDate && endDate) {
                periodEl.innerHTML = `<strong>Período de Referência:</strong> ${firstTeam.periodoReferencia[0]} a ${firstTeam.periodoReferencia[1]}`;
            } else {
                periodEl.innerHTML = 'Período de referência não definido.';
            }

            members.forEach(member => {
                const nickLower = member.nick.toLowerCase();
                const cargoLower = member.cargo ? member.cargo.toLowerCase() : '';
                let status = '';
                let motivo = '-';

                if (['comandante', 'subcomandante', 'perito(a)'].includes(cargoLower) || peritoNicks.has(nickLower)) {
                    status = 'VERIFICAR';
                    performanceData.push({ cargo: member.cargo, nick: member.nick, status, motivo });
                    return;
                }
                
                if (member.retornoLicenca && member.terminoLicenca && startDate && endDate && member.terminoLicenca >= startDate && member.terminoLicenca <= endDate) {
                    status = 'CASO ESPECIAL'; motivo = 'RET. LICENÇA';
                    performanceData.push({ cargo: member.cargo, nick: member.nick, status, motivo });
                    return;
                }

                if (member.inicioLicenca && (!member.terminoLicenca || member.terminoLicenca >= today)) {
                    status = 'CASO ESPECIAL'; motivo = 'LICENÇA';
                    performanceData.push({ cargo: member.cargo, nick: member.nick, status, motivo });
                    return;
                }
                
                if (member.entrada && startDate && endDate && member.entrada >= startDate && member.entrada <= endDate) {
                    status = 'CASO ESPECIAL'; motivo = 'NOVATO';
                    performanceData.push({ cargo: member.cargo, nick: member.nick, status, motivo });
                    return;
                }

                let scheduleRow = null;
                for (const teamData of schedule) {
                    if (teamData.isOmega) continue;
                    const foundRow = teamData.tableData.slice(1).find(r => r[0] && r[0].toLowerCase() === nickLower);
                    if (foundRow) {
                        scheduleRow = foundRow;
                        break;
                    }
                }
                
                if (scheduleRow) {
                    const tasks = [{ fisc: scheduleRow[3] }, { fisc: scheduleRow[4] }];
                    let doneCount = 0;
                    let justifiedCount = 0;

                    tasks.forEach(task => {
                        if (task.fisc && task.fisc !== '-') {
                            const isDone = activityMaps.fiscalizacoes.has(task.fisc) && activityMaps.fiscalizacoes.get(task.fisc).includes(nickLower);
                            const isJustified = activityMaps.justificativas.has(`${task.fisc}-${nickLower}`);
                            
                            if (isDone) doneCount++;
                            if (isJustified) justifiedCount++;
                        }
                    });
                    
                    if (justifiedCount > 0) {
                        status = 'CASO ESPECIAL';
                        motivo = 'JUSTIFICOU';
                        if (justifiedCount === 2) {
                             motivo += ' <i class="fas fa-triangle-exclamation text-yellow-300 ml-1" title="Justificou as duas tarefas"></i>';
                        }
                    } else if (doneCount === 2) {
                        status = 'REGULAR';
                    } else {
                        status = 'IRREGULAR';
                    }

                } else {
                    status = 'CASO ESPECIAL';
                    motivo = 'RESERVA';
                }
                
                performanceData.push({ cargo: member.cargo, nick: member.nick, status, motivo });
            });
            
            // Render the table
            const tableHTML = `
                <table class="min-w-full text-sm text-center">
                    <thead class="bg-black/30">
                        <tr>
                            <th class="py-2 px-3 text-left font-semibold text-purple-300">Cargo</th>
                            <th class="py-2 px-3 text-left font-semibold text-purple-300">Nick</th>
                            <th class="py-2 px-3 font-semibold text-purple-300">Status</th>
                            <th class="py-2 px-3 font-semibold text-purple-300">Motivo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${performanceData.map(p => `
                            <tr class="border-b border-white/20">
                                <td class="py-3 px-3 text-left">${p.cargo}</td>
                                <td class="py-3 px-3 text-left font-semibold">${p.nick}</td>
                                <td class="py-2 px-3">
                                    <span class="inline-block w-full py-1 px-3 rounded-md font-semibold status-${p.status.toLowerCase().replace(/ /g, '-').replace('caso-especial','especial')}">
                                        ${p.status.replace('CASO ESPECIAL', 'C. ESPECIAL')}
                                    </span>
                                </td>
                                <td class="py-3 px-3">${p.motivo}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = performanceData.length > 0 ? tableHTML : `<div class="text-center p-4">Não foi possível calcular o desempenho.</div>`;
        }

        function renderControls() {
            teamButtonsContainer.innerHTML = `<button class="control-btn active font-semibold py-2 px-4 rounded-md" data-team-id="all">Todas</button>`;
            processedSchedule.forEach(team => {
                 teamButtonsContainer.innerHTML += `<button class="control-btn font-semibold py-2 px-4 rounded-md" data-team-id="${team.id}">${team.name}</button>`;
            });
        }

        function displaySchedules(teamIdFilter, highlightedNick = null) {
            scheduleContainer.innerHTML = '';
            messageContainer.innerHTML = '';
            
            document.querySelectorAll('#team-buttons .control-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.teamId === teamIdFilter);
            });
            
            if(teamIdFilter !== 'all' && !highlightedNick) {
                searchInput.value = '';
            }
            
            const teamsToDisplay = teamIdFilter === 'all' 
                ? processedSchedule 
                : processedSchedule.filter(t => t.id === teamIdFilter);

            if (teamsToDisplay.length === 0 && highlightedNick) {
                 messageContainer.innerHTML = `<div class="glass-card text-yellow-300 text-center p-4"><p>Nenhum membro encontrado com o nick "${highlightedNick}".</p></div>`;
                 return;
            }

            teamsToDisplay.forEach(teamData => {
                const isOmegaEmpty = teamData.isOmega && teamData.tableData.every(row => !row[0]);

                if (isOmegaEmpty) {
                    if (teamIdFilter === 'all' || teamIdFilter === teamData.id) {
                         const omegaMessage = document.createElement('div');
                        omegaMessage.className = 'glass-card text-white p-6 text-center';
                        omegaMessage.innerHTML = `<h3 class="text-3xl font-bold text-center text-cyan-400 mb-2 drop-shadow-md">${teamData.name}</h3><p class="text-cyan-200">A Equipe Ômega não possui escala para esta semana.</p>`;
                        scheduleContainer.appendChild(omegaMessage);
                    }
                } else {
                    const teamElement = teamData.isOmega
                        ? renderOmegaTeam(teamData, highlightedNick)
                        : renderTeamSchedule(teamData, highlightedNick);
                    scheduleContainer.appendChild(teamElement);
                }
            });
        }

        function renderTeamSchedule(teamData, highlightedNick = null) {
            const teamElement = document.createElement('div');
            teamElement.className = 'glass-card text-white p-4 sm:p-6';
            
            const tableHeaders = teamData.tableData[0] || [];
            const tableRowsData = teamData.tableData.slice(1);
            
            let tableRowsHTML = tableRowsData.map(row => {
                const nick = row[0] || ''; if (!nick) return '';
                
                const isPeritoRow = nick.toLowerCase() === 'perito';
                const effectiveNick = isPeritoRow ? teamData.peritoResponsavel : nick;
                const isHighlighted = highlightedNick && (
                    (!isPeritoRow && nick.toLowerCase() === highlightedNick.toLowerCase()) ||
                    (isPeritoRow && teamData.peritoResponsavel.toLowerCase() === highlightedNick.toLowerCase())
                );

                const fisc1 = row[3] || '-'; const fisc2 = row[4] || '-';
                const post1 = row[6] || '-'; const post2 = row[7] || '-';
                
                let sFisc1 = getStatus(effectiveNick, fisc1, 'fiscalizacao', post1);
                let sFisc2 = getStatus(effectiveNick, fisc2, 'fiscalizacao', post2);
                let sPost1 = getStatus(effectiveNick, post1, 'postagem');
                let sPost2 = getStatus(effectiveNick, post2, 'postagem');
                
                return `<tr class="border-b border-white/10 ${isPeritoRow ? 'perito-row' : ''} ${isHighlighted ? 'highlight-row' : ''}">
                            <td class="py-3 px-4 font-medium border-r border-white/10">${nick}</td>
                            <td class="p-1 text-center border-r border-white/10"><span class="status-cell inline-block w-full p-2 ${sFisc1.class}" title="${sFisc1.tooltip}">${fisc1}</span></td>
                            <td class="p-1 text-center border-r border-white/10"><span class="status-cell inline-block w-full p-2 ${sFisc2.class}" title="${sFisc2.tooltip}">${fisc2}</span></td>
                            <td class="p-1 text-center border-r border-white/10"><span class="status-cell inline-block w-full p-2 ${sPost1.class}" title="${sPost1.tooltip}">${post1}</span></td>
                            <td class="p-1 text-center"><span class="status-cell inline-block w-full p-2 ${sPost2.class}" title="${sPost2.tooltip}">${post2}</span></td>
                        </tr>`;
            }).join('');
            
            const periodoRef = teamData.periodoReferencia.length > 1 ? `${teamData.periodoReferencia[0]} a ${teamData.periodoReferencia[1]}` : 'N/A';
            
            teamElement.innerHTML = `
                <h3 class="text-3xl font-bold text-center text-white mb-2 drop-shadow-md">${teamData.name}</h3>
                <p class="text-center text-purple-300 mb-6"><strong>Perito Responsável:</strong> ${teamData.peritoResponsavel}</p>
                <div class="bg-black/20 p-4 rounded-xl">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center mb-4 p-2 bg-black/20 rounded-lg items-center">
                        <div class="font-bold text-lg">${teamData.tituloFiscalizacao}</div>
                        <div class="font-bold text-lg">${teamData.tituloPostagem}</div>
                    </div>
                    <div class="overflow-x-auto"><table class="min-w-full text-sm">
                        <thead class="bg-black/30"><tr>
                            <th class="py-2 px-4 text-left border-r border-white/10">${tableHeaders[0] || 'Membro'}</th>
                            <th class="py-2 px-4 border-r border-white/10">${tableHeaders[3] || 'Fisc. 1'}</th>
                            <th class="py-2 px-4 border-r border-white/10">${tableHeaders[4] || 'Fisc. 2'}</th>
                            <th class="py-2 px-4 border-r border-white/10">${tableHeaders[6] || 'Post. 1'}</th>
                            <th class="py-2 px-4">${tableHeaders[7] || 'Post. 2'}</th>
                        </tr></thead><tbody>${tableRowsHTML}</tbody>
                    </table></div>
                </div>
                <div class="text-right text-xs text-purple-300 mt-4 pr-2"><strong>Período de Referência:</strong> ${periodoRef}</div>
            `;
            return teamElement;
        }

        function renderOmegaTeam(teamData, highlightedNick = null) {
            const teamElement = document.createElement('div');
            teamElement.className = 'glass-card text-white p-6';
            const nicksHTML = teamData.tableData.map(row => {
                const nick = row[0];
                if (!nick) return '';
                const isHighlighted = highlightedNick && nick.toLowerCase() === highlightedNick.toLowerCase();
                return `<li class="bg-black/20 p-3 rounded-lg ${isHighlighted ? 'highlight-row' : ''}">${nick}</li>`;
            }).join('');
            
            teamElement.innerHTML = `
                <h3 class="text-3xl font-bold text-center text-cyan-400 mb-2 drop-shadow-md">${teamData.name}</h3>
                <p class="text-center text-gray-300 mb-6"><strong>Perito Responsável:</strong> ${teamData.peritoResponsavel}</p>
                <div class="bg-black/20 p-4 rounded-xl">
                    <h4 class="font-semibold text-lg text-center mb-3">Membros da Equipe</h4>
                    <ul class="space-y-2 text-center">${nicksHTML}</ul>
                </div>
                <div class="text-center mt-6">
                    <a href="https://www.policiarcc.com/t31666-spp-orientacoes-aos-analistas" target="_blank" rel="noopener noreferrer" class="inline-block bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg">
                        <i class="fas fa-book-open mr-2"></i>Orientações aos Analistas
                    </a>
                </div>`;
            return teamElement;
        }

        // --- Event Handlers ---
        function handleSearch() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            if (!searchTerm) {
                displaySchedules('all');
                return;
            }

            let found = false;
            for (const team of processedSchedule) {
                // Check if the Perito matches
                if (team.peritoResponsavel.toLowerCase() === searchTerm) {
                    displaySchedules(team.id, team.peritoResponsavel);
                    found = true;
                    break;
                }

                // Check if a member matches
                const members = team.isOmega ? team.tableData : team.tableData.slice(1);
                const foundMember = members.find(row => row[0] && row[0].toLowerCase() === searchTerm);

                if (foundMember) {
                    displaySchedules(team.id, foundMember[0]);
                    found = true;
                    break;
                }
            }
            
            if (!found) {
                scheduleContainer.innerHTML = '';
                messageContainer.innerHTML = `<div class="glass-card text-yellow-300 text-center p-4"><p>Nenhum membro ou perito encontrado com o nome "${searchInput.value}".</p></div>`;
            }
        }

        // --- Event Listeners ---
        window.addEventListener('load', fetchAllData);

        teamButtonsContainer.addEventListener('click', (e) => {
            if (e.target.matches('button')) {
                const teamId = e.target.dataset.teamId;
                displaySchedules(teamId);
            }
        });

        searchBtn.addEventListener('click', handleSearch);
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });

        // --- Modal Listeners ---
        function setupModal(buttonId, modalId, closeButtonId) {
            const button = document.getElementById(buttonId);
            const modal = document.getElementById(modalId);
            const closeButton = document.getElementById(closeButtonId);

            button.addEventListener('click', () => modal.classList.remove('hidden'));
            closeButton.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => {
                if (e.target.id === modalId) {
                    modal.classList.add('hidden');
                }
            });
        }

        setupModal('help-btn', 'help-modal', 'close-help-btn');
        setupModal('warnings-btn', 'warnings-modal', 'close-warnings-btn');
        setupModal('performance-btn', 'performance-modal', 'close-performance-btn');

    </script>
</body>
</html>
